jQuery(function ($) {
    if ($('html').hasClass('et-fb-app-frame')) {
        $('.entry-content').removeClass('entry-content');
        return;
    }

    var mhmmWait = false;


    processClick = (el) => {
        let href = $(el).attr('href'),
            rel = $(el).attr('rel'),
            id = '';

        if (rel === undefined) {
            let hrefId = href.split('-');
            if (hrefId[hrefId.length - 1] != 'close') {
                id = hrefId[hrefId.length - 1];
            }
        } else {
            let relId = rel.split('-');
            id = relId[relId.length - 1];
        }

        // Close
        if (id == 'close') {
            $mhmmMenuLayoutOverlay = $(el).parents('.mhmm-menu-layout-overlay');
            mhmmMenuLayoutCloseOverlay($mhmmMenuLayoutOverlay);
        }

        // Open
        else {
            // If currently showing
            if ($('.mhmm-menu-layout-overlay-active').length && !mhmmWait) {
                mhmmMenuLayoutCurrentOverlayId = $('.mhmm-menu-layout-overlay-active').attr('id').substr(25);

                // If current is different from clicked, close current and open clicked
                if (mhmmMenuLayoutCurrentOverlayId != id) {
                    mhmmMenuLayoutCloseOverlay($('.mhmm-menu-layout-overlay-active'), id);
                }
                // Otherwise just close current
                else {
                    mhmmMenuLayoutCloseOverlay($('.mhmm-menu-layout-overlay-active'));
                }
            }
            else if (!mhmmWait) {
                mhmmMenuLayoutShowOverlay(id);
            }
        }
    }

    // Close when mobile menu icon is clicked
    $('.mobile_menu_bar_toggle').click(function (e) {
        if ($('body').hasClass('mhmm-menu-layout-active')) {
            $mhmmMenuLayoutOverlay = $('.mhmm-menu-layout-overlay-active');
            mhmmMenuLayoutCloseOverlay($mhmmMenuLayoutOverlay);
        }
    });

    // Preload menus unless button has mhmm-delay class
    $('*[href^="#mhmm-"], *[rel^="mhmm-"]').each(function () {
        if (!$(this).hasClass('mhmm-delay') && !$(this).parent().hasClass('mhmm-delay')) {
            let href = $(this).attr('href'),
                rel = $(this).attr('rel'),
                id = '';

            if (rel === undefined) {
                let hrefId = href.split('-');
                if (hrefId[hrefId.length - 1] != 'close') {
                    id = hrefId[hrefId.length - 1];
                }
            } else {
                let relId = rel.split('-');
                id = relId[relId.length - 1];
            }

            if (id !== '') {
                mhmmMenuLayoutShowOverlay(id, true);
            }
        }
    });

    // On click
    $('body').on('click', '*[href^="#mhmm-"], *[rel^="mhmm-"]', function (e) {
        e.preventDefault();
        let href = $(this).attr('href'),
            rel = $(this).attr('rel'),
            id = '';

        if (rel === undefined) {
            if (href !== '#') {
                processClick(this);
            }
        } else {
            window.location = href;
        }

    });

    // Close megamenu on click of .menu-button
    $('.et_pb_mhmm_menu .menu-button').click(function (e) {
        e.preventDefault();
        if ($('body').hasClass('mhmm-menu-layout-active') && !mhmmWait) {
            mhmmMenuLayoutCloseOverlay($('.mhmm-menu-layout-overlay-active'));
        }
    });

    // On hover (mouse devices only)
    var isTouch = ("ontouchstart" in document.documentElement);
    if (!isTouch) {
        var mouseEnterTimer;
        $('a[href^="#mhmm-"]:not([href="#mhmm-close"]):not(.mhmm-hover-triggered), a[rel^="mhmm-"]').on('mouseenter', function () {
            $hovered = $(this);
            mouseEnterTimer = setTimeout(function () {
                if ($hovered.parent('li').hasClass('mhmm-hover')) {
                    processClick($hovered);
                    $('.mhmm-hover-triggered').removeClass('mhmm-hover-triggered');
                    $hovered.addClass('mhmm-hover-triggered');
                }
            }, 200);
        }).on('mouseleave', function () {
            clearTimeout(mouseEnterTimer);
        });

        var mouseLeaveTimer;
        $('body').on('mouseleave', '.mhmm-menu-layout-overlay, .mhmm-hover-triggered', function (e) {
            mouseLeaveTimer = setTimeout(function () {
                if ($('.mhmm-hover-triggered').length && !$(e.toElement).parents('.mhmm-hover').length && !$(e.toElement).hasClass('mhmm-menu-layout-overlay') && !$(e.toElement).parents('.mhmm-menu-layout-overlay').length && !$(e.toElement).hasClass('mhmm-hover-triggered')) {
                    mhmmMenuLayoutCloseOverlay($('.mhmm-menu-layout-overlay-active'));
                    $('.mhmm-hover-triggered').removeClass('mhmm-hover-triggered');
                }
            }, 200);
        }).on('mouseenter', '.mhmm-menu-layout-overlay, .mhmm-hover-triggered', function (e) {
            clearTimeout(mouseLeaveTimer);
        });
    }

    mhmmMenuLayoutCloseOverlay = function ($mhmmMenuLayoutOverlay, mhmmMenuLayoutOverlayIdOpen) {
        if (!mhmmWait) {
            $('.using-mhmm header').off('touchmove click');
            $('.mhmm-active-trigger').removeClass('mhmm-active-trigger');
            if ($mhmmMenuLayoutOverlay.hasClass('mhmm-menu-layout-transition-fade')) {
                mhmmWait = true;
                $mhmmMenuLayoutOverlay.fadeOut(300, function () {
                    $('body').removeClass('mhmm-menu-layout-active mhmm-menu-active');
                    $(this).removeClass('mhmm-menu-layout-overlay-active');
                    mhmmWait = false;
                    if (typeof mhmmMenuLayoutOverlayIdOpen !== 'undefined') {
                        mhmmMenuLayoutShowOverlay(mhmmMenuLayoutOverlayIdOpen)
                    }
                });
            }
            if ($mhmmMenuLayoutOverlay.hasClass('mhmm-menu-layout-transition-slide')) {
                mhmmWait = true;
                $mhmmMenuLayoutOverlay.slideUp(300, function () {
                    $('body').removeClass('mhmm-menu-layout-active mhmm-menu-active');
                    $(this).removeClass('mhmm-menu-layout-overlay-active');
                    mhmmWait = false;
                    if (typeof mhmmMenuLayoutOverlayIdOpen !== 'undefined') {
                        mhmmMenuLayoutShowOverlay(mhmmMenuLayoutOverlayIdOpen)
                    }
                });
            }
            if ($mhmmMenuLayoutOverlay.hasClass('mhmm-menu-layout-transition-none')) {
                mhmmWait = true;
                $mhmmMenuLayoutOverlay.hide(0, function () {
                    $('body').removeClass('mhmm-menu-layout-active mhmm-menu-active');
                    $(this).removeClass('mhmm-menu-layout-overlay-active');
                    mhmmWait = false;
                    if (typeof mhmmMenuLayoutOverlayIdOpen !== 'undefined') {
                        mhmmMenuLayoutShowOverlay(mhmmMenuLayoutOverlayIdOpen)
                    }
                });
            }
        }
    }
    function mhmmMenuLayoutShowOverlay(mhmmMenuLayoutOverlayId, loadOnly) {
        if (typeof loadOnly == 'undefined') {
            loadOnly = false;
        }

        // If markup isn't in place, add it
        if (!$('#mhmm-menu-layout-overlay-' + mhmmMenuLayoutOverlayId).length) {

            // Set up classes
            mhmmMenuLayoutOverlayClasses = ['mhmm-menu-layout-overlay'];
            if (!loadOnly) {
                mhmmMenuLayoutOverlayClasses.push('mhmm-menu-layout-overlay-active');
            }
            if (mhmm_menu_layout.layouts[mhmmMenuLayoutOverlayId].background) {
                if (mhmm_menu_layout.layouts[mhmmMenuLayoutOverlayId].background == 'dark') {
                    mhmmMenuLayoutOverlayClasses.push('mhmm-menu-layout-overlay-dark');
                }
                else if (mhmm_menu_layout.layouts[mhmmMenuLayoutOverlayId].background == 'light') {
                    mhmmMenuLayoutOverlayClasses.push('mhmm-menu-layout-overlay-light');
                }
            }
            if (mhmm_menu_layout.layouts[mhmmMenuLayoutOverlayId]['transition'] !== '') {
                mhmmMenuLayoutOverlayClasses.push('mhmm-menu-layout-transition-' + mhmm_menu_layout.layouts[mhmmMenuLayoutOverlayId]['transition']);
            } else {
                mhmmMenuLayoutOverlayClasses.push('mhmm-menu-layout-transition-fade');
            }

            mhmmMenuLayoutMarkup = '<div id="mhmm-menu-layout-overlay-' + mhmmMenuLayoutOverlayId + '" class="' + mhmmMenuLayoutOverlayClasses.join(' ') + '">';
            mhmmMenuLayoutMarkup += mhmm_menu_layout.layouts[mhmmMenuLayoutOverlayId]['content'];
            // mhmmMenuLayoutMarkup += '<div class="mhmm-menu-layout-iframe-loader"></div>';
            if (mhmm_menu_layout.layouts[mhmmMenuLayoutOverlayId]['close']) {
                mhmmMenuLayoutMarkup += '<a class="mhmm-menu-layout-close-button" href="#mhmm-close" style="color: ' + mhmm_menu_layout.layouts[mhmmMenuLayoutOverlayId]['close_color'] + '; background-color: ' + mhmm_menu_layout.layouts[mhmmMenuLayoutOverlayId]['close_background_color'] + ';"></a>';
            }
            mhmmMenuLayoutMarkup += '</div>';

            if ($('#main-content > .et-l').length) {
                $('#main-content > .et-l').prepend(mhmmMenuLayoutMarkup);
            } else {
                $('#main-content').addClass('et-l');
                $('#main-content').prepend(mhmmMenuLayoutMarkup);
            }




            $('#mhmm-menu-layout-overlay-' + mhmmMenuLayoutOverlayId).addClass('mhmm-menu-layout-iframe-loaded');
            $('#mhmm-menu-layout-overlay-' + mhmmMenuLayoutOverlayId + ' .mhmm-menu-layout-iframe-loader').remove();
        }

        if (!loadOnly) {
            // Prevent scroll weirdness on mobile
            $('.using-mhmm header').bind('touchmove', function (e) {
                e.preventDefault()
            });

            // Set trigger state
            $('a[href="#mhmm-' + mhmmMenuLayoutOverlayId + '"]').addClass('mhmm-active-trigger');

            window.setTimeout(function () {
                $('body').addClass('mhmm-menu-layout-active');
            }, 1);

            // Calculate heights
            if ($('body').hasClass('mhmm-sticky-bottom') || ($('body').hasClass('mhmm-sticky-bottom-scroll') && !$('body').hasClass('mhmm-scrolled'))) {
                var verticalOffset = $('header').innerHeight();
                $('.mhmm-menu-layout-overlay').css({
                    'bottom': verticalOffset,
                    'top': 'auto'
                });
                $('.mhmm-menu-layout-overlay').css({
                    'maxHeight': ($.windowHeight() - verticalOffset) + 'px'
                });
            }
            else {
                $header = $('.using-mhmm header');
                var scrollTop = $(window).scrollTop(),
                    headerOffset = $header.offset().top,
                    distanceFromTopOfWindow = headerOffset - scrollTop,
                    verticalOffset = $header.innerHeight() + headerOffset;
                $('body:not(.et_vertical_nav):not(.mhmm-scrolled) .mhmm-menu-layout-overlay').css({
                    'top': verticalOffset
                });
                $('body.mhmm-scrolled:not(.et_vertical_nav) .mhmm-menu-layout-overlay').css({
                    'top': (distanceFromTopOfWindow + $header.innerHeight()) + 'px'
                });
                $('.mhmm-menu-layout-overlay').css({
                    'maxHeight': $.windowHeight() - ($('header').innerHeight() + distanceFromTopOfWindow) + 'px'
                });
            }

            mhmmWait = true;
            $('#mhmm-menu-layout-overlay-' + mhmmMenuLayoutOverlayId + '.mhmm-menu-layout-overlay.mhmm-menu-layout-transition-fade').fadeIn(300, function () {
                $(this).addClass('mhmm-menu-layout-overlay-active');
                mhmmWait = false;
            });
            $('#mhmm-menu-layout-overlay-' + mhmmMenuLayoutOverlayId + '.mhmm-menu-layout-overlay.mhmm-menu-layout-transition-slide').slideDown(300, function () {
                $(this).addClass('mhmm-menu-layout-overlay-active');
                mhmmWait = false;
            });
            $('#mhmm-menu-layout-overlay-' + mhmmMenuLayoutOverlayId + '.mhmm-menu-layout-overlay.mhmm-menu-layout-transition-none').show(0, function () {
                $(this).addClass('mhmm-menu-layout-overlay-active');
                mhmmWait = false;
            });
        }
    }
});